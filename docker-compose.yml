version: '3.3'

services:
  database:
    image: mongo:3.4-jessie
    networks:
      - default
    ports:
    - 27017
    volumes:
    - db_data:/data/db
    restart: unless-stopped

  defichain:
    build: ./defichain
    networks: 
      - default
    environment: 
      - NETWORK=${NETWORK:?network env required}
    ports:
      - 8555
      - 8554
      - 18555
      - 18554
      - 19555
      - 19554
    volumes:
      - node_data:/data
      - ./defichain/defi.${NETWORK}.conf:/root/.defi/defi.conf
    restart: unless-stopped

  bitcore-node:
    build: .
    image: bitcore-node
    # network_mode: host
    networks:
      - default
    command: "bash -c 'cd ./packages/bitcore-node/; npm run tsc; node build/src/server.js'"
    ports:
      - 3000:3000
    environment:
      - NETWORK=${NETWORK:?network env required}
      - DB_HOST=database
      - CHAIN=DFI
      - BITCORE_CONFIG_PATH=bitcore.config.json
    volumes: 
      - ./bitcore.${NETWORK}.config.json:/usr/src/app/bitcore.config.json
    depends_on:
      - database
      - defichain
    restart: unless-stopped

  insight:
    build: .
    image: insight
    # network_mode: host
    networks:
      - default
    command: ["npm", "run", "insight-previous:prod"]
    ports:
      - 80:5000
    environment:
      # - ENV=prod
      - NETWORK=${NETWORK:?network env required}
      - API_PREFIX=${API_PREFIX:?api_prefix env required}
      - CHAIN=DFI
      - BITCORE_CONFIG_PATH=bitcore.config.json
    volumes: 
      - ./bitcore.${NETWORK}.config.json:/usr/src/app/bitcore.config.json
    depends_on:
      - bitcore-node
    restart: unless-stopped

volumes: 
  db_data:
  node_data:
